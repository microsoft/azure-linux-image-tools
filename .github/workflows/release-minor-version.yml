# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: Release (major/minor)

permissions: {}

on:
  # Allow pipeline to be run manually.
  workflow_dispatch:
    inputs:
      noPublishRelease:
        description: Do not publish release (only fork the release branch)
        required: true
        type: boolean
        default: false

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      publishType: official
      runFunctionalTests: true
      runVMTests: true
    permissions:
      contents: read
      # Azure login
      id-token: write

  publish-container:
    uses: ./.github/workflows/publish-container.yml
    if: ${{ !(inputs.noPublishRelease || false) }}
    needs:
    - build
    permissions:
      # "Keyless" container signing
      id-token: write
      # Publish to GHCR.
      packages: write

  publish-release:
    uses: ./.github/workflows/publish-release.yml
    if: ${{ !(inputs.noPublishRelease || false) }}
    with:
      isLatestRelease: true
    needs:
    - build
    permissions:
      # Create release tag and publish release.
      contents: write

  fork-release-branch:
    uses: ./.github/workflows/fork-release-branch.yml
    needs:
    - build
    permissions:
      # Create release branch.
      contents: write

  open-bump-version-pr:
    uses: ./.github/workflows/open-bump-version-pr.yml
    needs:
    - build
    permissions:
      # Create release branch and publish release.
      contents: write
      # Publish PR.
      #pull-requests: write

  publish-github-pages:
    uses: ./.github/workflows/publish-github-pages.yml
    if: ${{ !(inputs.noPublishRelease || false) }}
    needs:
    - build
    permissions:
      # GitHub pages publish.
      pages: write
      id-token: write