# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

name: Build binary, container, and docs

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      publishType:
        required: true
        type: string
      runFunctionalTests:
        required: true
        type: boolean
    outputs:
      isLatestRelease:
        value: ${{ jobs.binary-build-amd64.outputs.isLatestRelease }}

jobs:
  binary-build-amd64:
    name: Build AMD64
    uses: ./.github/workflows/binary-build.yml
    with:
      publishType: ${{ inputs.publishType }}
      arch: amd64

  binary-build-arm64:
    name: Build ARM64
    uses: ./.github/workflows/binary-build.yml
    with:
      publishType: ${{ inputs.publishType }}
      arch: arm64

  build-docs:
    uses: ./.github/workflows/docs-build.yml

  tests-functional-azl3-amd64:
    name: Functional tests AZL3 AMD64
    if: ${{ inputs.runFunctionalTests }}
    uses: ./.github/workflows/tests-functional.yml
    with:
      hostArch: amd64
      hostDistro: azl3

  # ARM64 images aren't available in MCR yet.
  # tests-functional-azl3-arm64:
  #  name: Functional tests AZL3 ARM64
  #  if: ${{ inputs.runFunctionalTests }}
  #  uses: ./.github/workflows/tests-functional.yml
  #  with:
  #    hostArch: arm64
  #    hostDistro: azl3

  tests-functional-ubuntu2404-amd64:
    name: Functional tests Ubuntu24.04 AMD64
    if: ${{ inputs.runFunctionalTests }}
    uses: ./.github/workflows/tests-functional.yml
    with:
      hostArch: amd64
      hostDistro: ubuntu2404
